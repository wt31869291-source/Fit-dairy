<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥åº·æ—¥è¨˜</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #fdfcf8; --text: #4a4a4a; --green: #a3b18a; --blue: #9eb3c2; --pink: #eac4d5; --orange: #e6a27e; --card: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
        
        /* åº•éƒ¨å°è¦½ */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 9999; }
        .nav-item { text-decoration: none; font-size: 1.4rem; color: #aaa; text-align: center; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--blue); }
        .nav-item span { display: block; font-size: 0.7rem; }

        .page { display: none; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }

        /* é¦–é ç¶“å…¸å¸ƒå±€ */
        .home-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
        .home-coach { width: 45%; font-size: 0.85rem; color: var(--orange); background: #fff5f0; padding: 10px; border-radius: 10px; border-left: 4px solid var(--orange); }

        /* æœˆæ›† */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { aspect-ratio: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.85rem; cursor: pointer; background: #fff; border: 1px solid #f0f0f0; position: relative; }
        .day.today { border: 2px solid var(--blue); color: var(--blue); font-weight: bold; }
        .day.selected { background: var(--blue) !important; color: white !important; }
        .dot-container { display: flex; gap: 2px; margin-top: 2px; position: absolute; bottom: 3px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }

        /* æ¸…å–®èˆ‡è¼¸å…¥ */
        .log-item { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .btn-main { background: var(--blue); color: white; width: 100%; border: none; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9rem; font-weight: bold; margin-bottom: 8px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .sug-box { color: var(--blue); font-size: 0.8rem; padding: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="home" class="page active">
        <div class="home-header">
            <div>
                <div style="font-size: 1.5rem; font-weight: bold;">å¥åº·æ—¥è¨˜</div>
                <div id="h-today-date" style="font-size: 0.9rem; color: #888; margin-top: 5px;"></div>
            </div>
            <div class="home-coach" id="h-coach">è¼‰å…¥ä¸­...</div>
        </div>
        <div class="card" style="text-align: center;">
            <div style="font-size: 0.9rem; color: #888;">ä»Šæ—¥å‰©é¤˜ç†±é‡</div>
            <div style="font-size: 3rem; font-weight: bold; color: var(--green); margin: 10px 0;" id="h-rem-kcal">--</div>
            <div style="display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 15px;">
                <div style="flex:1">æ”å–<br><b id="h-eat">0</b></div>
                <div style="flex:1; border-left:1px solid #eee; border-right:1px solid #eee;">é£²æ°´<br><b id="h-water">0</b><div id="h-water-status" style="font-size: 0.7rem; color: var(--orange);"></div></div>
                <div style="flex:1">é«”é‡<br><b id="h-w">--</b></div>
            </div>
        </div>
    </div>

    <div id="record" class="page">
        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <button onclick="changeMonth(-1)">â—€</button>
                <h3 id="cal-month-title"></h3>
                <button onclick="changeMonth(1)">â–¶</button>
            </div>
            <div class="calendar-grid" id="cal-body"></div>
            <div id="cal-alert" style="margin-top:10px; font-size:0.85rem; color:var(--orange); text-align:center; min-height: 1.2rem;"></div>
        </div>

        <div id="edit-area" class="card" style="display:none;">
            <h3 id="edit-date-display" style="color: var(--blue); border-bottom: 1px solid #eee; padding-bottom: 10px;"></h3>
            
            <div class="input-group">
                <label>ğŸ• é£Ÿç‰©ç†±é‡</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="food-n" placeholder="åç¨± (å¦‚:ç‚’é’èœ)" oninput="searchFoodSuggest(this.value)">
                    <input type="number" id="food-k" placeholder="å¡" style="width:80px;">
                    <button onclick="addLogItem('food')" style="border-radius:8px; border:none; background:var(--blue); color:white; padding:0 15px;">+</button>
                </div>
                <div id="food-sug-ui" class="sug-box"></div>
                <div id="food-list-ui" style="margin-top:10px;"></div>
            </div>

            <div class="input-group"><label>ğŸ’§ é£²æ°´ (ml)</label><input type="number" id="in-water"></div>
            <div class="input-group"><label>âš–ï¸ é«”é‡ (ç©ºè…¹/ç¡å‰)</label><div style="display:flex; gap:5px;"><input type="number" id="w-m" placeholder="ç©ºè…¹"><input type="number" id="w-n" placeholder="ç¡å‰"></div></div>
            <div class="input-group"><label>ğŸ“ åœåº¦ (è…°/è‡€/è…¿)</label><div style="display:flex; gap:5px;"><input type="number" id="s-w" placeholder="è…°"><input type="number" id="s-h" placeholder="è‡€"><input type="number" id="s-l" placeholder="è…¿"></div></div>
            
            <div class="input-group">
                <label>ğŸ‹ï¸ é‹å‹•</label>
                <select id="sport-sel"></select>
                <button onclick="addLogItem('sport')" class="btn-main" style="background:var(--green); font-size:0.9rem; padding:10px;">åŠ å…¥ä»Šæ—¥é‹å‹•æ¸…å–®</button>
                <div id="sport-list-ui" style="margin-top:10px;"></div>
            </div>

            <div class="input-group"><label><input type="checkbox" id="is-period"> ğŸŒ¸ ä»Šå¤©æ˜¯ç”Ÿç†æœŸ</label></div>
            <button class="btn-main" onclick="saveDay()">ç¢ºèªå„²å­˜</button>
        </div>
    </div>

    <div id="chart" class="page">
        <div class="card"><h3>é«”é‡è¶¨å‹¢</h3><canvas id="wChart"></canvas></div>
        <div class="card"><h3>åœåº¦è¶¨å‹¢</h3><canvas id="sChart"></canvas></div>
    </div>

    <div id="profile" class="page">
        <div class="card">
            <h3>ğŸ‘¤ å€‹äººè³‡æ–™</h3>
            <label>ç”Ÿæ—¥</label><input type="date" id="p-bday">
            <label>èº«é«˜ (cm)</label><input type="number" id="p-h">
            <label>é«”é‡ (kg)</label><input type="number" id="p-w">
            <button class="btn-main" style="background:var(--green);" onclick="saveProf()">å„²å­˜è³‡æ–™</button>
        </div>
        <div class="card">
            <h3>ğŸƒ è‡ªè¨‚é‹å‹•</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="cs-name" placeholder="åç¨±">
                <button onclick="addCS()" style="border-radius:8px; border:none; background:var(--blue); color:white; padding:0 15px;">+</button>
            </div>
            <div id="cs-list-ui"></div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="nav('home', this)">ğŸ <span>é¦–é </span></div>
        <div class="nav-item" onclick="nav('record', this)">ğŸ“<span>ç´€éŒ„</span></div>
        <div class="nav-item" onclick="nav('chart', this)">ğŸ“ˆ<span>åœ–è¡¨</span></div>
        <div class="nav-item" onclick="nav('profile', this)">ğŸ‘¤<span>å€‹äºº</span></div>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('hd_v6_db')) || {};
        let prof = JSON.parse(localStorage.getItem('hd_v6_prof')) || { bday:'', h:160, w:55, sports:['æ•£æ­¥','æ‰“æƒ'] };
        let viewDate = new Date();
        let selDate = "";
        let curF = [], curS = [];
        const foodLib = { "ç‚’é’èœ":100, "é›èƒ¸è‚‰":165, "ç™½é£¯":280, "æ’éª¨éºµ":600, "çå¥¶":500 };

        function nav(p, el) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(ni => ni.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            el.classList.add('active');
            if(p==='home') updateHome();
            if(p==='record') renderCal();
            if(p==='chart') setTimeout(renderCharts, 100);
            if(p==='profile') renderProfPage();
        }

        // --- é¦–é  ---
        function updateHome() {
            const today = new Date().toISOString().split('T')[0];
            const data = db[today] || { food:[], water:0, wm:0 };
            const age = prof.bday ? (2026 - new Date(prof.bday).getFullYear()) : 25;
            const bmr = Math.round(10*prof.w + 6.25*prof.h - 5*age - 161);
            const eat = (data.food||[]).reduce((s,f)=>s+f.k, 0);
            
            document.getElementById('h-today-date').innerText = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'long', day:'numeric'});
            document.getElementById('h-eat').innerText = eat;
            document.getElementById('h-water').innerText = data.water || 0;
            document.getElementById('h-w').innerText = data.wm || '--';
            document.getElementById('h-rem-kcal').innerText = bmr - eat;
            
            let wGoal = prof.w * 35;
            document.getElementById('h-water-status').innerText = data.water >= wGoal ? "âœ… å·²é”æ¨™" : `é‚„å·® ${Math.max(0, wGoal - data.water)}ml`;
            document.getElementById('h-coach').innerText = data.period ? "ğŸŒ¸ ç”Ÿç†æœŸè¨˜å¾—ä¿æš–å–”ï¼" : (eat > bmr ? "âš ï¸ ç†±é‡ç¨å¾®è¶…æ¨™å›‰ï¼Œå‹•ä¸€å‹•å§ï¼" : "ğŸ’¡ ç›®å‰ç‹€æ…‹è‰¯å¥½ï¼ŒåŠ æ²¹ï¼");
        }

        // --- ç´€éŒ„ ---
        function renderCal() {
            const body = document.getElementById('cal-body'); body.innerHTML = '';
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('cal-month-title').innerText = `${y}å¹´ ${m+1}æœˆ`;
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m+1, 0).getDate();
            const bmr = 1500; // ç°¡åŒ–

            for(let i=0; i<first; i++) body.appendChild(document.createElement('div'));
            for(let i=1; i<=last; i++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = `day ${selDate===ds?'selected':''}`;
                el.innerText = i;
                if(db[ds]) {
                    el.innerHTML += `<div class="dot-container">` + 
                        ((db[ds].food||[]).reduce((s,f)=>s+f.k,0) > bmr ? `<div class="dot" style="background:red"></div>` : '') +
                        (db[ds].water < 1500 ? `<div class="dot" style="background:blue"></div>` : '') + `</div>`;
                }
                el.onclick = () => { selDate = ds; openEdit(ds); renderCal(); };
                body.appendChild(el);
            }
        }

        function openEdit(ds) {
            document.getElementById('edit-area').style.display = 'block';
            document.getElementById('edit-date-display').innerText = `æ­£åœ¨ç·¨è¼¯ï¼š${ds}`;
            const data = db[ds] || { food:[], water:0, wm:0, wn:0, wa:0, hi:0, le:0, sports:[], period:false };
            curF = data.food || []; curS = data.sports || [];
            document.getElementById('in-water').value = data.water || '';
            document.getElementById('w-m').value = data.wm || '';
            document.getElementById('w-n').value = data.wn || '';
            document.getElementById('s-w').value = data.wa || '';
            document.getElementById('s-h').value = data.hi || '';
            document.getElementById('s-l').value = data.le || '';
            document.getElementById('is-period').checked = data.period || false;
            
            const sel = document.getElementById('sport-sel');
            sel.innerHTML = prof.sports.map(s => `<option value="${s}">${s}</option>`).join('');
            refreshUI();
            
            // é»æ“Šè­¦å‘Š
            const eat = curF.reduce((s,f)=>s+f.k,0);
            document.getElementById('cal-alert').innerText = (eat > 1600 ? "âš ï¸ ç†±é‡è¶…æ¨™ " : "") + (data.water < 1500 ? "ğŸ’§ æ°´åˆ†ä¸è¶³" : "");
        }

        function searchFoodSuggest(v) {
            const m = Object.keys(foodLib).find(k => k.includes(v));
            document.getElementById('food-sug-ui').innerHTML = (v && m) ? `<span onclick="setF('${m}',${foodLib[m]})">ğŸ’¡ å»ºè­°: ${m} (${foodLib[m]}å¡)</span>` : '';
        }
        function setF(n,k) { document.getElementById('food-n').value=n; document.getElementById('food-k').value=k; }

        function addLogItem(type) {
            if(type==='food') {
                const n = document.getElementById('food-n').value;
                const k = Number(document.getElementById('food-k').value);
                if(n && k) { 
                    curF.push({n, k}); 
                    document.getElementById('food-n').value = ''; 
                    document.getElementById('food-k').value = ''; 
                    document.getElementById('food-sug-ui').innerHTML = '';
                }
            } else {
                curS.push({n: document.getElementById('sport-sel').value});
            }
            refreshUI();
        }

        function refreshUI() {
            document.getElementById('food-list-ui').innerHTML = curF.map((f,i)=>`<div class="log-item">${f.n} (${f.k}k) <b onclick="curF.splice(${i},1);refreshUI()">âœ•</b></div>`).join('');
            document.getElementById('sport-list-ui').innerHTML = curS.map((s,i)=>`<div class="log-item">${s.n} <b onclick="curS.splice(${i},1);refreshUI()">âœ•</b></div>`).join('');
        }

        function saveDay() {
            db[selDate] = { food:curF, water:Number(document.getElementById('in-water').value), wm:Number(document.getElementById('w-m').value), wn:Number(document.getElementById('w-n').value), wa:Number(document.getElementById('s-w').value), hi:Number(document.getElementById('s-h').value), le:Number(document.getElementById('s-l').value), sports:curS, period:document.getElementById('is-period').checked };
            localStorage.setItem('hd_v6_db', JSON.stringify(db));
            alert("å„²å­˜å®Œæˆ");
            updateHome();
        }

        // --- å€‹äººè³‡æ–™ ---
        function renderProfPage() {
            document.getElementById('p-bday').value = prof.bday;
            document.getElementById('p-h').value = prof.h;
            document.getElementById('p-w').value = prof.w;
            document.getElementById('cs-list-ui').innerHTML = prof.sports.map((s,i)=>`<div class="log-item">${s} <b onclick="prof.sports.splice(${i},1);saveProf();renderProfPage()">âœ•</b></div>`).join('');
        }
        function saveProf() {
            prof.bday = document.getElementById('p-bday').value;
            prof.h = Number(document.getElementById('p-h').value);
            prof.w = Number(document.getElementById('p-w').value);
            localStorage.setItem('hd_v6_prof', JSON.stringify(prof));
            alert("å·²å„²å­˜");
        }
        function addCS() {
            const n = document.getElementById('cs-name').value;
            if(n) { prof.sports.push(n); document.getElementById('cs-name').value=''; saveProf(); renderProfPage(); }
        }

        // --- åœ–è¡¨ ---
        function renderCharts() {
            const dates = Object.keys(db).sort().slice(-7);
            const wCtx = document.getElementById('wChart').getContext('2d');
            const sCtx = document.getElementById('sChart').getContext('2d');
            
            new Chart(wCtx, { type: 'line', data: { labels: dates, datasets: [{ label: 'é«”é‡', data: dates.map(d=>db[d].wm), borderColor: '#9eb3c2', tension:0.3 }] } });
            new Chart(sCtx, { type: 'line', data: { labels: dates, datasets: [
                { label: 'è…°', data: dates.map(d=>db[d].wa), borderColor: '#a3b18a' },
                { label: 'è‡€', data: dates.map(d=>db[d].hi), borderColor: '#eac4d5' },
                { label: 'è…¿', data: dates.map(d=>db[d].le), borderColor: '#e6a27e' }
            ] } });
        }

        function changeMonth(s) { viewDate.setMonth(viewDate.getMonth()+s); renderCal(); }
        window.onload = () => { updateHome(); };
    </script>
</body>
</html>
