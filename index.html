<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥åº·æ—¥è¨˜</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #fdfcf8; --text: #4a4a4a; --green: #a3b18a; --blue: #9eb3c2; --pink: #eac4d5; --orange: #e6a27e; --card: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
        
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 9999; }
        .nav-item { text-decoration: none; font-size: 1.4rem; color: #aaa; text-align: center; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--blue); }
        .nav-item span { display: block; font-size: 0.7rem; }

        .page { display: none; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }

        /* é¦–é  */
        .home-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
        .home-coach { width: 45%; font-size: 0.85rem; color: var(--orange); background: #fff5f0; padding: 10px; border-radius: 10px; border-left: 4px solid var(--orange); }

        /* æœˆæ›† */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { aspect-ratio: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.85rem; cursor: pointer; background: #fff; border: 1px solid #f0f0f0; position: relative; }
        .day.today { border: 2px solid var(--blue); color: var(--blue); font-weight: bold; background: #f0f7ff; }
        .day.selected { background: var(--blue) !important; color: white !important; }
        .dot-container { display: flex; gap: 2px; position: absolute; bottom: 3px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }

        /* å½ˆçª—æ¨£å¼ */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; justify-content: center; align-items: center; }
        .modal { background: white; padding: 20px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; }

        /* ç´€éŒ„èˆ‡è¼¸å…¥ */
        .log-item { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .counter-btn { width: 25px; height: 25px; border-radius: 50%; border: 1px solid #ddd; background: #fff; line-height: 23px; text-align: center; cursor: pointer; }
        .input-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn-main { background: var(--blue); color: white; width: 100%; border: none; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="modal-overlay" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>ä»Šæ—¥ç†±é‡ä½”æ¯”</h3>
            <canvas id="modalPieChart" style="max-height: 200px;"></canvas>
            <div id="modal-info" style="margin-top: 15px; font-size: 0.9rem;"></div>
            <button class="btn-main" onclick="closeModal()" style="margin-top: 15px; padding: 10px;">é—œé–‰</button>
        </div>
    </div>

    <div id="home" class="page active">
        <div class="home-header">
            <div>
                <div style="font-size: 1.5rem; font-weight: bold;">å¥åº·æ—¥è¨˜</div>
                <div id="h-today-date" style="font-size: 0.9rem; color: #888; margin-top: 5px;"></div>
            </div>
            <div class="home-coach" id="h-coach">æ­£åœ¨åˆ†æ...</div>
        </div>
        <div class="card" style="text-align: center; cursor: pointer;" onclick="openKcalModal()">
            <div style="font-size: 0.9rem; color: #888;">ä»Šæ—¥å‰©é¤˜ç†±é‡ (é»æ“Šçœ‹åœ–è¡¨)</div>
            <div style="font-size: 3rem; font-weight: bold; color: var(--green); margin: 10px 0;" id="h-rem-kcal">--</div>
            <div style="display: flex; justify-content: space-around; border-top: 1px solid #eee; padding-top: 15px;">
                <div>æ”å–<br><b id="h-eat">0</b></div>
                <div style="border-left:1px solid #eee; border-right:1px solid #eee; padding: 0 20px;">é£²æ°´<br><b id="h-water">0</b><div id="h-water-status" style="font-size: 0.7rem; color: var(--orange);"></div></div>
                <div>é‹å‹•æ¶ˆè€—<br><b id="h-burn">0</b></div>
            </div>
        </div>
    </div>

    <div id="record" class="page">
        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <button onclick="changeMonth(-1)">â—€</button>
                <h3 id="cal-month-title"></h3>
                <button onclick="changeMonth(1)">â–¶</button>
            </div>
            <div class="calendar-grid" id="cal-body"></div>
            <div id="cal-alert" style="margin-top:10px; font-size:0.85rem; color:red; text-align:center; font-weight:bold;"></div>
        </div>

        <div id="edit-area" class="card" style="display:none;">
            <h3 id="edit-date-display" style="color: var(--blue);"></h3>
            
            <div class="input-group">
                <label>ğŸ• é£Ÿç‰©æ”å–</label>
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" id="food-n" placeholder="åç¨±" oninput="suggestF(this.value)">
                    <input type="number" id="food-k" placeholder="å¡" style="width:80px;">
                    <button onclick="addF()" style="background:var(--blue); color:white; border:none; border-radius:8px; padding:0 15px;">+</button>
                </div>
                <div id="food-sug" style="font-size:0.8rem; color:var(--blue); cursor:pointer;"></div>
                <div id="food-list-ui"></div>
            </div>

            <div class="input-group"><label>ğŸ’§ é£²æ°´ (ml)</label><input type="number" id="in-water"></div>
            <div class="input-group"><label>âš–ï¸ é«”é‡ (ç©ºè…¹/ç¡å‰)</label><div style="display:flex; gap:5px;"><input type="number" id="w-m" placeholder="ç©ºè…¹"><input type="number" id="w-n" placeholder="ç¡å‰"></div></div>
            
            <div class="input-group">
                <label>ğŸ‹ï¸ é‹å‹•ç´€éŒ„ (é¸æ“‡å¾Œè¼¸å…¥æ•¸å€¼)</label>
                <select id="sport-sel"></select>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <input type="number" id="sport-val" placeholder="æ•¸å€¼" style="flex:1;">
                    <button onclick="addS()" style="background:var(--green); color:white; border:none; border-radius:8px; padding:0 20px;">åŠ å…¥</button>
                </div>
                <div id="sport-list-ui" style="margin-top:10px;"></div>
            </div>

            <label><input type="checkbox" id="is-period"> ğŸŒ¸ ç”Ÿç†æœŸç´€éŒ„</label>
            <button class="btn-main" onclick="saveDay()">å„²å­˜ä»Šæ—¥æ•¸æ“š</button>
        </div>
    </div>

    <div id="chart" class="page">
        <div class="card"><h3>é«”é‡è¶¨å‹¢</h3><canvas id="wChart"></canvas></div>
        <div class="card"><h3>åœåº¦è¶¨å‹¢</h3><canvas id="sChart"></canvas></div>
    </div>

    <div id="profile" class="page">
        <div class="card">
            <h3>ğŸ‘¤ å€‹äººè³‡æ–™</h3>
            <label>ç”Ÿæ—¥</label><input type="date" id="p-bday">
            <label>èº«é«˜ (cm)</label><input type="number" id="p-h">
            <label>é«”é‡ (kg)</label><input type="number" id="p-w">
            <button class="btn-main" style="background:var(--green);" onclick="saveProf()">å„²å­˜è³‡æ–™</button>
        </div>
        <div class="card">
            <h3>ğŸƒ è‡ªè¨‚é‹å‹•å¼·åº¦ (METå€¼)</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="cs-name" placeholder="åç¨±">
                <input type="number" id="cs-met" placeholder="MET" style="width:60px;">
                <select id="cs-unit" style="width:70px;"><option value="åˆ†">åˆ†</option><option value="çµ„">çµ„</option></select>
                <button onclick="addCS()" style="background:var(--blue); color:white; border:none; border-radius:8px; padding:0 15px;">+</button>
            </div>
            <small style="color:#888;">*MET: æ•£æ­¥ç´„3, è·‘æ­¥ç´„8, æ‰“æƒç´„3.5</small>
            <div id="cs-list-ui" style="margin-top:10px;"></div>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="nav('home', this)">ğŸ <span>é¦–é </span></div>
        <div class="nav-item" onclick="nav('record', this)">ğŸ“<span>ç´€éŒ„</span></div>
        <div class="nav-item" onclick="nav('chart', this)">ğŸ“ˆ<span>åœ–è¡¨</span></div>
        <div class="nav-item" onclick="nav('profile', this)">ğŸ‘¤<span>å€‹äºº</span></div>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('hd_v7_db')) || {};
        let prof = JSON.parse(localStorage.getItem('hd_v7_prof')) || { bday:'', h:160, w:55, sports:[{n:'æ•£æ­¥', m:3, u:'åˆ†'}, {n:'æ‰“æƒ', m:3.5, u:'åˆ†'}] };
        let viewDate = new Date();
        let selDate = new Date().toISOString().split('T')[0];
        let curF = [], curS = [];
        const foodLib = { "ç‚’é’èœ":100, "é›èƒ¸è‚‰":165, "ç™½é£¯":280, "æ’éª¨éºµ":600, "æ°´ç…®è›‹":75 };
        let modalChart = null;

        function nav(p, el) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(ni => ni.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            el.classList.add('active');
            if(p==='home') updateHome();
            if(p==='record') { renderCal(); openEdit(selDate); }
            if(p==='chart') setTimeout(renderTrend, 100);
            if(p==='profile') renderProf();
        }

        function getBMR() {
            const age = prof.bday ? (2026 - new Date(prof.bday).getFullYear()) : 25;
            return Math.round(10 * prof.w + 6.25 * prof.h - 5 * age - 161);
        }

        // --- é¦–é èˆ‡åœ“é¤…åœ– ---
        function updateHome() {
            const today = new Date().toISOString().split('T')[0];
            const data = db[today] || { food:[], water:0, sports:[] };
            const bmr = getBMR();
            const eat = (data.food||[]).reduce((s,f)=>s+f.k, 0);
            const burn = (data.sports||[]).reduce((s,x)=>s+x.k, 0);
            
            document.getElementById('h-today-date').innerText = new Date().toLocaleDateString('zh-TW', {month:'long', day:'numeric', weekday:'long'});
            document.getElementById('h-eat').innerText = eat;
            document.getElementById('h-burn').innerText = Math.round(burn);
            document.getElementById('h-water').innerText = data.water || 0;
            document.getElementById('h-rem-kcal').innerText = bmr - eat + Math.round(burn);
            
            let wGoal = prof.w * 35;
            document.getElementById('h-water-status').innerText = data.water >= wGoal ? "âœ… é”æ¨™" : `ç¼º ${Math.round(wGoal - data.water)}ml`;
            document.getElementById('h-coach').innerText = (eat > bmr + burn) ? "âš ï¸ ç†±é‡æ”å–éå¤šå›‰ï¼" : "ğŸ’¡ ç›®å‰ç¯€å¥å¾ˆå¥½ï¼Œç¹¼çºŒä¿æŒï¼";
        }

        function openKcalModal() {
            document.getElementById('modal-overlay').style.display = 'flex';
            const today = new Date().toISOString().split('T')[0];
            const data = db[today] || { food:[] };
            const eat = (data.food||[]).reduce((s,f)=>s+f.k, 0);
            const bmr = getBMR();
            const rem = Math.max(0, bmr - eat);

            const ctx = document.getElementById('modalPieChart').getContext('2d');
            if(modalChart) modalChart.destroy();
            modalChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å·²æ”å–', 'å‰©é¤˜é¡åº¦'],
                    datasets: [{ data: [eat, rem], backgroundColor: [eat > bmr ? '#e6a27e' : '#a3b18a', '#eee'] }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
            document.getElementById('modal-info').innerText = `åŸºç¤ä»£è¬ï¼š${bmr} kcal\nä»Šæ—¥å·²æ”å–ï¼š${eat} kcal`;
        }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        // --- ç´€éŒ„ ---
        function renderCal() {
            const body = document.getElementById('cal-body'); body.innerHTML = '';
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('cal-month-title').innerText = `${y}å¹´ ${m+1}æœˆ`;
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m+1, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];

            for(let i=0; i<first; i++) body.appendChild(document.createElement('div'));
            for(let i=1; i<=last; i++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = `day ${ds === todayStr ? 'today' : ''} ${selDate === ds ? 'selected' : ''}`;
                el.innerText = i;
                if(db[ds]) {
                    el.innerHTML += `<div class="dot-container">` + 
                        ((db[ds].food||[]).reduce((s,f)=>s+f.k,0) > getBMR() ? `<div class="dot" style="background:red"></div>` : '') +
                        (db[ds].water < prof.w*35 ? `<div class="dot" style="background:blue"></div>` : '') + `</div>`;
                }
                el.onclick = () => { selDate = ds; openEdit(ds); renderCal(); };
                body.appendChild(el);
            }
        }

        function openEdit(ds) {
            document.getElementById('edit-area').style.display = 'block';
            document.getElementById('edit-date-display').innerText = `ğŸ“… ç·¨è¼¯æ—¥æœŸï¼š${ds}`;
            const data = db[ds] || { food:[], water:0, wm:0, sports:[] };
            curF = data.food || []; curS = data.sports || [];
            document.getElementById('in-water').value = data.water || '';
            document.getElementById('w-m').value = data.wm || '';
            document.getElementById('is-period').checked = data.period || false;
            
            document.getElementById('sport-sel').innerHTML = prof.sports.map(s => `<option value='${JSON.stringify(s)}'>${s.n} (${s.u})</option>`).join('');
            refreshUI();
            checkAlert();
        }

        function addF() {
            const n = document.getElementById('food-n').value;
            const k = Number(document.getElementById('food-k').value);
            if(n && k) { curF.push({n, k}); document.getElementById('food-n').value=''; document.getElementById('food-k').value=''; refreshUI(); checkAlert(); }
        }

        function addS() {
            const sObj = JSON.parse(document.getElementById('sport-sel').value);
            const val = Number(document.getElementById('sport-val').value);
            if(val) {
                // ç†±é‡å…¬å¼: MET * é«”é‡ * (åˆ†é˜/60) | å¦‚æœæ˜¯çµ„æ•¸ï¼Œæš«å®šä¸€çµ„ 3 åˆ†é˜
                const mins = sObj.u === 'åˆ†' ? val : val * 3;
                const kcal = sObj.m * prof.w * (mins / 60);
                curS.push({ n: sObj.n, v: val, u: sObj.u, k: kcal });
                document.getElementById('sport-val').value = '';
                refreshUI();
            }
        }

        function refreshUI() {
            document.getElementById('food-list-ui').innerHTML = curF.map((f,i)=>`<div class="log-item">${f.n} (${f.k}k) <b onclick="curF.splice(${i},1);refreshUI();checkAlert()">âœ•</b></div>`).join('');
            document.getElementById('sport-list-ui').innerHTML = curS.map((s,i)=>`<div class="log-item">${s.n} ${s.v}${s.u} (ç´„-${Math.round(s.k)}k) <b onclick="curS.splice(${i},1);refreshUI()">âœ•</b></div>`).join('');
        }

        function checkAlert() {
            const eat = curF.reduce((s,f)=>s+f.k, 0);
            document.getElementById('cal-alert').innerText = (eat > getBMR()) ? "âš ï¸ è­¦å‘Šï¼šä»Šæ—¥æ”å–ç†±é‡å·²è¶…æ¨™ï¼" : "";
        }

        function saveDay() {
            db[selDate] = { food:curF, water:Number(document.getElementById('in-water').value), wm:Number(document.getElementById('w-m').value), sports:curS, period:document.getElementById('is-period').checked };
            localStorage.setItem('hd_v7_db', JSON.stringify(db));
            alert("å„²å­˜æˆåŠŸï¼");
            updateHome();
        }

        // --- å€‹äººè³‡æ–™ ---
        function renderProf() {
            document.getElementById('p-bday').value = prof.bday;
            document.getElementById('p-h').value = prof.h;
            document.getElementById('p-w').value = prof.w;
            document.getElementById('cs-list-ui').innerHTML = prof.sports.map((s,i)=>`<div class="log-item">${s.n} (MET:${s.m}) <b onclick="prof.sports.splice(${i},1);saveProf();renderProf()">âœ•</b></div>`).join('');
        }
        function saveProf() {
            prof.bday = document.getElementById('p-bday').value;
            prof.h = Number(document.getElementById('p-h').value);
            prof.w = Number(document.getElementById('p-w').value);
            localStorage.setItem('hd_v7_prof', JSON.stringify(prof));
            alert("å·²æ›´æ–°");
        }
        function addCS() {
            const n = document.getElementById('cs-name').value;
            const m = Number(document.getElementById('cs-met').value);
            const u = document.getElementById('cs-unit').value;
            if(n && m) { prof.sports.push({n, m, u}); saveProf(); renderProf(); }
        }

        function changeMonth(s) { viewDate.setMonth(viewDate.getMonth()+s); renderCal(); }
        function suggestF(v) {
            const m = Object.keys(foodLib).find(k => k.includes(v));
            document.getElementById('food-sug').innerHTML = (v && m) ? `<span onclick="document.getElementById('food-n').value='${m}';document.getElementById('food-k').value=${foodLib[m]};document.getElementById('food-sug').innerHTML=''">ğŸ’¡ å»ºè­°: ${m} (${foodLib[m]}k)</span>` : '';
        }

        window.onload = () => { updateHome(); };
    </script>
</body>
</html>
