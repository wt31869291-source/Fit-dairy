<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥åº·æ—¥è¨˜</title>
    <style>
        :root { --bg: #fdfcf8; --text: #4a4a4a; --green: #a3b18a; --blue: #9eb3c2; --pink: #eac4d5; --orange: #e6a27e; --card: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; }
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        /* æœˆæ›† */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { aspect-ratio: 1; border: 1px solid #f0f0f0; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; position: relative; background: #fff; }
        .day.today { border: 2px solid var(--blue); font-weight: bold; color: var(--blue); }
        .day.selected { background: #eee; }
        .dots { display: flex; gap: 2px; position: absolute; bottom: 3px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }

        /* è¼¸å…¥æ¡†èˆ‡å»ºè­°æ¸…å–® */
        .input-group { margin-bottom: 15px; position: relative; }
        label { display: block; font-size: 0.85rem; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .suggestions { position: absolute; background: white; width: 100%; z-index: 10; border: 1px solid #ddd; border-radius: 8px; max-height: 150px; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .sug-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .sug-item:hover { background: #f0f4f0; }

        /* å°è¦½ */
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; }
        .nav-item { text-decoration: none; font-size: 1.5rem; color: #aaa; text-align: center; }
        .nav-item.active { color: var(--blue); }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="home" class="page active">
        <div class="card">
            <h2>ğŸ  å¥åº·æ—¥è¨˜</h2>
            <div id="coach" style="padding:10px; border-left:4px solid var(--green); background:#f0f4f0;">è¼‰å…¥å»ºè­°ä¸­...</div>
        </div>
        <div class="card" style="text-align: center;">
            <div style="font-size: 0.9rem; color: #888;">ä»Šæ—¥å‰©é¤˜ç†±é‡</div>
            <div style="font-size: 2.8rem; font-weight: bold; color: var(--green);" id="rem-kcal">--</div>
            <div style="display:flex; justify-content: space-around; margin-top:15px;">
                <div>æ”å– <br><b id="h-eat">0</b></div>
                <div>æ¶ˆè€— <br><b id="h-burn">0</b></div>
                <div>æ°´ <br><b id="h-water">0</b></div>
            </div>
        </div>
    </div>

    <div id="record" class="page">
        <div class="card"><div class="calendar-grid" id="cal"></div></div>
        <div id="edit-area" class="card" style="display:none;">
            <h3 id="date-title">æ—¥æœŸ</h3>
            <label><input type="checkbox" id="is-period"> ğŸŒ¸ ç”Ÿç†æœŸ</label>
            <div class="input-group">
                <label>é£Ÿç‰©æœå°‹ (å¦‚: ç‚’é’èœ)</label>
                <input type="text" id="food-search" placeholder="è¼¸å…¥é—œéµå­—..." oninput="searchFood(this.value)">
                <div id="food-sugs" class="suggestions" style="display:none;"></div>
                <div id="food-list" style="margin-top:10px; font-size:0.8rem; color:#666;"></div>
            </div>
            <div class="input-group">
                <label>é‹å‹•</label>
                <select id="sport-select"></select>
                <input type="number" id="sport-time" placeholder="åˆ†é˜">
            </div>
            <div class="input-group">
                <label>é£²æ°´ (mL)</label>
                <input type="number" id="in-water">
            </div>
            <div class="input-group">
                <label>é«”é‡ (kg)</label>
                <div style="display:flex; gap:5px;"><input type="number" id="w-m" placeholder="ç©ºè…¹"><input type="number" id="w-n" placeholder="ç¡å‰"></div>
            </div>
            <div class="input-group">
                <label>èº«å½¢åœåº¦ (cm)</label>
                <div style="display:flex; gap:5px;"><input type="number" id="s-waist" placeholder="è…°åœ"><input type="number" id="s-hip" placeholder="è‡€åœ"><input type="number" id="s-leg" placeholder="è…¿åœ"></div>
            </div>
            <button class="btn" style="background:var(--blue); color:white;" onclick="saveDay()">å„²å­˜ä»Šæ—¥æ•¸æ“š</button>
        </div>
    </div>

    <div id="profile" class="page">
        <div class="card">
            <h3>ğŸ‘¤ å€‹äººè³‡æ–™</h3>
            <div class="input-group"><label>æ€§åˆ¥</label><select id="p-gen"><option value="F">å¥³</option><option value="M">ç”·</option></select></div>
            <div class="input-group"><label>ç”Ÿæ—¥</label><input type="date" id="p-bday"></div>
            <div class="input-group"><label>èº«é«˜ (cm)</label><input type="number" id="p-h"></div>
            <div class="input-group"><label>é«”é‡ (kg)</label><input type="number" id="p-w"></div>
            <button class="btn" style="background:var(--green); color:white;" onclick="saveProfile()">å„²å­˜ä¸¦è¨ˆç®—ä»£è¬</button>
        </div>
        <div class="card">
            <h3>ğŸƒ è‡ªè¨‚é‹å‹•æ¸…å–®</h3>
            <div class="input-group">
                <input type="text" id="custom-sport-name" placeholder="åç¨± (å¦‚: è·³ç¹©)">
                <input type="number" id="custom-sport-met" placeholder="æ¶ˆè€—ä¿‚æ•¸ (ä¸­å¼·åº¦å¡« 6)">
                <button class="btn" onclick="addCustomSport()">æ–°å¢é‹å‹•</button>
            </div>
            <div id="custom-list"></div>
        </div>
    </div>

    <nav class="nav">
        <a href="#" class="nav-item active" onclick="nav('home')">ğŸ <span>é¦–é </span></a>
        <a href="#" class="nav-item" onclick="nav('record')">ğŸ“<span>ç´€éŒ„</span></a>
        <a href="#" class="nav-item" onclick="nav('profile')">ğŸ‘¤<span>å€‹äºº</span></a>
    </nav>

    <script>
        // è³‡æ–™åº«èˆ‡åˆå§‹åŒ–
        let db = JSON.parse(localStorage.getItem('health_db')) || {};
        let prof = JSON.parse(localStorage.getItem('health_prof')) || { sports: [] };
        let selectedDate = "";
        const foodDB = [
            {n:"ç‚’é’èœ", k:100}, {n:"æ’éª¨éºµ", k:600}, {n:"ç‰›è‚‰éºµ", k:800}, {n:"è è˜¿éºµåŒ…", k:350}, {n:"é›èƒ¸è‚‰", k:165}, {n:"ç™½é£¯", k:280}
        ];

        function nav(p) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(ni => ni.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            event.currentTarget.classList.add('active');
            if(p==='home') updateHome();
            if(p==='record') renderCal();
            if(p==='profile') loadProfile();
        }

        // --- å€‹äººè³‡æ–™èˆ‡è‡ªè¨‚åŠŸèƒ½ ---
        function saveProfile() {
            prof.gen = document.getElementById('p-gen').value;
            prof.bday = document.getElementById('p-bday').value;
            prof.h = Number(document.getElementById('p-h').value);
            prof.w = Number(document.getElementById('p-w').value);
            localStorage.setItem('health_prof', JSON.stringify(prof));
            alert("å€‹äººè³‡æ–™å·²æ°¸ä¹…å„²å­˜ï¼");
        }

        function loadProfile() {
            document.getElementById('p-gen').value = prof.gen || 'F';
            document.getElementById('p-bday').value = prof.bday || '';
            document.getElementById('p-h').value = prof.h || '';
            document.getElementById('p-w').value = prof.w || '';
            renderCustomSports();
        }

        function addCustomSport() {
            const name = document.getElementById('custom-sport-name').value;
            const met = document.getElementById('custom-sport-met').value;
            if(name && met) {
                prof.sports.push({ name, met: Number(met) });
                localStorage.setItem('health_prof', JSON.stringify(prof));
                renderCustomSports();
            }
        }

        function renderCustomSports() {
            const list = document.getElementById('custom-list');
            const select = document.getElementById('sport-select');
            list.innerHTML = '';
            select.innerHTML = '<option value="0">é¸æ“‡é‹å‹•...</option>';
            prof.sports.forEach((s, i) => {
                list.innerHTML += `<div>${s.name} (ä¿‚æ•¸:${s.met}) <button onclick="prof.sports.splice(${i},1);localStorage.setItem('health_prof',JSON.stringify(prof));renderCustomSports();">åˆªé™¤</button></div>`;
                select.innerHTML += `<option value="${s.met}">${s.name}</option>`;
            });
        }

        // --- é£Ÿç‰©æœå°‹é‚è¼¯ ---
        let currentDayKcal = 0;
        function searchFood(q) {
            const sug = document.getElementById('food-sugs');
            if(!q) { sug.style.display='none'; return; }
            const matches = foodDB.filter(f => f.n.includes(q));
            sug.innerHTML = matches.map(f => `<div class="sug-item" onclick="pickFood('${f.n}', ${f.k})">${f.n} (${f.k}å¡)</div>`).join('');
            sug.style.display = matches.length ? 'block' : 'none';
        }

        function pickFood(name, kcal) {
            currentDayKcal += kcal;
            document.getElementById('food-list').innerHTML += `<div>${name} +${kcal}å¡</div>`;
            document.getElementById('food-search').value = '';
            document.getElementById('food-sugs').style.display = 'none';
        }

        // --- ç´€éŒ„å„²å­˜ ---
        function renderCal() {
            const cal = document.getElementById('cal'); cal.innerHTML = '';
            const todayStr = new Date().toISOString().split('T')[0];
            for(let i=1; i<=31; i++) {
                let d = `2026-01-${String(i).padStart(2,'0')}`;
                let has = db[d];
                let el = document.createElement('div');
                el.className = `day ${todayStr===d?'today':''} ${selectedDate===d?'selected':''}`;
                el.innerHTML = i;
                if(has) {
                    el.innerHTML += `<div class="dots">` + 
                        (has.food > 0 ? `<div class="dot" style="background:red"></div>` : '') +
                        (has.water > 0 ? `<div class="dot" style="background:blue"></div>` : '') + `</div>`;
                }
                el.onclick = () => { selectedDate=d; document.getElementById('edit-area').style.display='block'; document.getElementById('date-title').innerText=d; loadDayData(d); renderCal(); };
                cal.appendChild(el);
            }
        }

        function loadDayData(d) {
            let data = db[d] || { food:0, water:0, wm:0, wn:0, waist:0, hip:0, leg:0, period:false };
            currentDayKcal = data.food;
            document.getElementById('food-list').innerHTML = data.food ? `ä»Šæ—¥å·²è¨ˆ: ${data.food}å¡` : '';
            document.getElementById('in-water').value = data.water || "";
            document.getElementById('w-m').value = data.wm || "";
            document.getElementById('w-n').value = data.wn || "";
            document.getElementById('s-waist').value = data.waist || "";
            document.getElementById('s-hip').value = data.hip || "";
            document.getElementById('s-leg').value = data.leg || "";
            document.getElementById('is-period').checked = data.period || false;
        }

        function saveDay() {
            const met = Number(document.getElementById('sport-select').value);
            const time = Number(document.getElementById('sport-time').value);
            const burn = prof.w ? (met * prof.w * (time/60)) : 0;

            db[selectedDate] = {
                food: currentDayKcal,
                water: Number(document.getElementById('in-water').value),
                wm: Number(document.getElementById('w-m').value),
                wn: Number(document.getElementById('w-n').value),
                waist: Number(document.getElementById('s-waist').value),
                hip: Number(document.getElementById('s-hip').value),
                leg: Number(document.getElementById('s-leg').value),
                period: document.getElementById('is-period').checked,
                burn: burn
            };
            localStorage.setItem('health_db', JSON.stringify(db));
            alert("ä»Šæ—¥ç´€éŒ„å·²æ°¸ä¹…å„²å­˜ï¼");
            renderCal();
        }

        function updateHome() {
            const today = new Date().toISOString().split('T')[0];
            const data = db[today] || {food:0, water:0, burn:0};
            // åŸºç¤ BMR è¨ˆç®—
            let age = prof.bday ? (new Date().getFullYear() - new Date(prof.bday).getFullYear()) : 25;
            let bmr = prof.h ? (prof.gen==='M' ? (10*prof.w + 6.25*prof.h - 5*age + 5) : (10*prof.w + 6.25*prof.h - 5*age - 161)) : 1500;
            
            document.getElementById('h-eat').innerText = data.food;
            document.getElementById('h-burn').innerText = Math.round(data.burn || 0);
            document.getElementById('h-water').innerText = data.water;
            document.getElementById('rem-kcal').innerText = Math.round(bmr - data.food + (data.burn || 0));
            
            let msg = "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼";
            if(data.food > bmr + 200) msg = "âš ï¸ ç†±é‡æ”å–è¼ƒå¤šï¼Œå»ºè­°å¢åŠ é‹å‹•æˆ–æ¸›å°‘ä¸‹ä¸€é¤ä»½é‡ã€‚";
            if(data.period) msg = "ğŸŒ¸ ç”Ÿç†æœŸç‰¹åˆ¥è¾›è‹¦ï¼Œè¨˜å¾—å¤šå–æº«æ°´ï¼Œæ”¾æ…¢ç¯€å¥ã€‚";
            document.getElementById('coach').innerText = msg;
        }

        // åˆå§‹åŒ–
        window.onload = () => { loadProfile(); updateHome(); };
    </script>
</body>
</html>
