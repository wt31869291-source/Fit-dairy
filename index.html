<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥åº·æ—¥è¨˜</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #fdfcf8; --text: #4a4a4a; --green: #a3b18a; --blue: #9eb3c2; --pink: #eac4d5; --orange: #e6a27e; --card: #ffffff; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; }
        
        /* åº•éƒ¨å°è¦½ */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #eee; z-index: 9999; }
        .nav-item { text-decoration: none; font-size: 1.4rem; color: #aaa; text-align: center; flex: 1; }
        .nav-item.active { color: var(--blue); }
        .nav-item span { display: block; font-size: 0.7rem; }

        .page { display: none; padding: 20px; box-sizing: border-box; }
        .page.active { display: block; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 15px; }

        /* é¦–é ç¶“å…¸å¸ƒå±€ */
        .home-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
        .home-title { font-size: 1.5rem; font-weight: bold; color: var(--text); }
        .home-date { font-size: 0.9rem; color: #888; margin-top: 5px; }
        .home-coach { width: 45%; font-size: 0.85rem; color: var(--orange); background: #fff5f0; padding: 10px; border-radius: 10px; border-left: 4px solid var(--orange); }

        /* æœˆæ›† */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day { aspect-ratio: 1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.85rem; cursor: pointer; background: #fff; border: 1px solid #f0f0f0; position: relative; }
        .day.today { border: 2px solid var(--blue); color: var(--blue); font-weight: bold; }
        .day.selected { background: var(--blue) !important; color: white !important; }
        .dot-container { display: flex; gap: 2px; margin-top: 2px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; }

        /* é€šç”¨æ¸…å–®æ¨£å¼ */
        .log-item { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .btn-main { background: var(--blue); color: white; width: 100%; border: none; padding: 15px; border-radius: 10px; font-weight: bold; margin-top: 15px; }
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="home" class="page active">
        <div class="home-header">
            <div>
                <div class="home-title">å¥åº·æ—¥è¨˜</div>
                <div class="home-date" id="h-today-date">2026å¹´ 1æœˆ 21æ—¥</div>
            </div>
            <div class="home-coach" id="h-coach">æ­£åœ¨åˆ†ææ•¸æ“š...</div>
        </div>

        <div class="card" style="text-align: center;">
            <div style="font-size: 0.9rem; color: #888;">ä»Šæ—¥å‰©é¤˜ç†±é‡</div>
            <div style="font-size: 3rem; font-weight: bold; color: var(--green); margin: 10px 0;" id="h-rem-kcal">--</div>
            <div style="display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 15px;">
                <div style="flex:1">æ”å–<br><b id="h-eat">0</b></div>
                <div style="flex:1; border-left:1px solid #eee; border-right:1px solid #eee;">
                    é£²æ°´<br><b id="h-water">0</b>
                    <div id="h-water-status" style="font-size: 0.7rem; color: var(--orange);"></div>
                </div>
                <div style="flex:1">é«”é‡<br><b id="h-w">--</b></div>
            </div>
        </div>
    </div>

    <div id="record" class="page">
        <div class="card">
            <div class="cal-header">
                <button onclick="changeMonth(-1)">â—€</button>
                <h3 id="cal-month-title">2026å¹´ 1æœˆ</h3>
                <button onclick="changeMonth(1)">â–¶</button>
            </div>
            <div class="calendar-grid" id="cal-body"></div>
            <div id="cal-alert" style="margin-top:10px; font-size:0.8rem; color:red; min-height:1.2rem;"></div>
        </div>

        <div id="edit-area" class="card" style="display:none;">
            <h3 id="selected-date-title">æ—¥æœŸ</h3>
            
            <div class="input-group">
                <label>ğŸ• é£Ÿç‰©</label>
                <div style="display:flex; gap:5px;"><input type="text" id="food-n" placeholder="é£Ÿç‰©åç¨±"><input type="number" id="food-k" placeholder="å¡" style="width:80px;"><button onclick="addItem('food')" style="border-radius:8px; border:none; background:var(--blue); color:white; padding:0 15px;">+</button></div>
                <div id="food-list-ui" style="margin-top:10px;"></div>
            </div>

            <div class="input-group"><label>ğŸ’§ é£²æ°´ (ml)</label><input type="number" id="in-water"></div>
            <div class="input-group"><label>âš–ï¸ é«”é‡ (ç©ºè…¹/ç¡å‰)</label><div style="display:flex; gap:5px;"><input type="number" id="w-m" placeholder="ç©ºè…¹"><input type="number" id="w-n" placeholder="ç¡å‰"></div></div>
            <div class="input-group"><label>ğŸ“ åœåº¦ (è…°/è‡€/è…¿)</label><div style="display:flex; gap:5px;"><input type="number" id="s-w"><input type="number" id="s-h"><input type="number" id="s-l"></div></div>
            
            <div class="input-group">
                <label>ğŸ‹ï¸ é‹å‹•é …ç›®</label>
                <select id="sport-sel" style="width:100%; padding:10px; border-radius:8px;"></select>
                <button onclick="addItem('sport')" class="btn-main" style="background:var(--green); margin-top:8px; padding:10px;">åŠ å…¥ä»Šæ—¥é‹å‹•</button>
                <div id="sport-list-ui" style="margin-top:10px;"></div>
            </div>

            <div class="input-group"><label><input type="checkbox" id="is-period"> ğŸŒ¸ ç”Ÿç†æœŸç´€éŒ„</label></div>
            <button class="btn-main" onclick="saveAll()">å„²å­˜ç´€éŒ„</button>
        </div>
    </div>

    <div id="chart" class="page">
        <div class="card"><h3>é«”é‡è¶¨å‹¢</h3><canvas id="weightChart"></canvas></div>
        <div class="card"><h3>åœåº¦è¶¨å‹¢</h3><canvas id="sizeChart"></canvas></div>
    </div>

    <div id="profile" class="page">
        <div class="card">
            <h3>ğŸ‘¤ å€‹äººè³‡æ–™</h3>
            <label>ç”Ÿæ—¥</label><input type="date" id="p-bday" style="margin-bottom:10px;">
            <label>èº«é«˜ (cm)</label><input type="number" id="p-h" style="margin-bottom:10px;">
            <label>ç•¶å‰é«”é‡ (kg)</label><input type="number" id="p-w">
            <button class="btn-main" style="background:var(--green);" onclick="saveProfile()">å„²å­˜ä¸¦è¨ˆç®— BMR</button>
        </div>
    </div>

    <nav class="nav">
        <a href="javascript:void(0)" class="nav-item active" onclick="nav('home', this)">ğŸ <span>é¦–é </span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="nav('record', this)">ğŸ“<span>ç´€éŒ„</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="nav('chart', this)">ğŸ“ˆ<span>åœ–è¡¨</span></a>
        <a href="javascript:void(0)" class="nav-item" onclick="nav('profile', this)">ğŸ‘¤<span>å€‹äºº</span></a>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('hd_v5_db')) || {};
        let prof = JSON.parse(localStorage.getItem('hd_v5_prof')) || { bday:'', h:0, w:0, sports:[{n:"æ•£æ­¥", u:"åˆ†"}] };
        let viewDate = new Date();
        let selectedDate = "";
        let tmpFood = [], tmpSport = [];

        function nav(p, el) {
            document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(ni => ni.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            el.classList.add('active');
            if(p==='home') updateHome();
            if(p==='record') renderCalendar();
            if(p==='chart') renderCharts();
            if(p==='profile') { document.getElementById('p-bday').value=prof.bday; document.getElementById('p-h').value=prof.h; document.getElementById('p-w').value=prof.w; }
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function getBMR() {
            if(!prof.h || !prof.w) return 1500;
            let age = 2026 - new Date(prof.bday).getFullYear();
            return Math.round(10 * prof.w + 6.25 * prof.h - 5 * age - 161); // ä»¥å¥³æ€§å…¬å¼ç‚ºé è¨­
        }

        function updateHome() {
            const today = new Date().toISOString().split('T')[0];
            const data = db[today] || { food:[], water:0, wm:0 };
            const bmr = getBMR();
            const eat = (data.food || []).reduce((s,f)=>s+f.k, 0);
            const waterGoal = prof.w * 35 || 2000;

            document.getElementById('h-today-date').innerText = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'long', day:'numeric'});
            document.getElementById('h-eat').innerText = eat;
            document.getElementById('h-water').innerText = data.water;
            document.getElementById('h-w').innerText = data.wm || '--';
            document.getElementById('h-rem-kcal').innerText = bmr - eat;
            
            // é£²æ°´ç‹€æ…‹
            let wDiff = Math.round(waterGoal - data.water);
            document.getElementById('h-water-status').innerText = wDiff > 0 ? `é‚„å·® ${wDiff}ml` : "ğŸ‰ å·²é”æ¨™";

            // æ•™ç·´è¨Šæ¯
            let msg = "ä»Šå¤©ä¹Ÿè¦åŠ æ²¹å–”ï¼";
            if(data.water < waterGoal/2) msg = "ğŸ’§ å–æ°´å¤ªå°‘å•¦ï¼Œèº«é«”æœƒä»£è¬è®Šæ…¢å–”ï¼";
            if(eat > bmr) msg = "âš ï¸ æ”å–å·²è¶…éåŸºç¤ä»£è¬ï¼Œå‹•èµ·ä¾†ï¼";
            if(data.period) msg = "ğŸŒ¸ ç”Ÿç†æœŸè¨˜å¾—ä¿æš–ï¼Œè¾›è‹¦äº†ã€‚";
            document.getElementById('h-coach').innerText = msg;
        }

        // --- æœˆæ›†èˆ‡è­¦å‘Š ---
        function renderCalendar() {
            const body = document.getElementById('cal-body'); body.innerHTML = '';
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('cal-month-title').innerText = `${y}å¹´ ${m+1}æœˆ`;
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m+1, 0).getDate();
            const bmr = getBMR();
            const waterGoal = prof.w * 35 || 2000;

            for(let i=0; i<first; i++) body.appendChild(document.createElement('div'));
            for(let i=1; i<=last; i++) {
                const ds = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = `day ${selectedDate===ds?'selected':''}`;
                el.innerText = i;
                
                if(db[ds]) {
                    const eat = (db[ds].food||[]).reduce((s,f)=>s+f.k, 0);
                    const water = db[ds].water || 0;
                    let dots = '<div class="dot-container">';
                    if(eat > bmr) dots += '<div class="dot" style="background:red"></div>';
                    if(water < waterGoal) dots += '<div class="dot" style="background:blue"></div>';
                    dots += '</div>';
                    el.innerHTML += dots;
                }
                
                el.onclick = () => { 
                    selectedDate = ds; 
                    showDayAlert(ds, bmr, waterGoal);
                    openEdit(ds); 
                    renderCalendar(); 
                };
                body.appendChild(el);
            }
        }

        function showDayAlert(ds, bmr, waterGoal) {
            const data = db[ds];
            const info = document.getElementById('cal-alert');
            if(!data) { info.innerText = ""; return; }
            let alerts = [];
            const eat = (data.food||[]).reduce((s,f)=>s+f.k, 0);
            if(eat > bmr) alerts.push("âš ï¸ ç†±é‡è¶…æ¨™");
            if(data.water < waterGoal) alerts.push("ğŸ’§ æ°´åˆ†ä¸è¶³");
            info.innerText = alerts.length ? alerts.join(' / ') : "âœ… é€™å¤©è¡¨ç¾å¾ˆæ£’ï¼";
        }

        function openEdit(ds) {
            document.getElementById('edit-area').style.display='block';
            document.getElementById('selected-date-title').innerText = ds;
            const data = db[ds] || { food:[], water:0, wm:0, wn:0, wa:0, hi:0, le:0, sports:[], period:false };
            tmpFood = data.food || [];
            tmpSport = data.sports || [];
            document.getElementById('in-water').value = data.water || '';
            document.getElementById('w-m').value = data.wm || '';
            document.getElementById('w-n').value = data.wn || '';
            document.getElementById('s-w').value = data.wa || '';
            document.getElementById('s-h').value = data.hi || '';
            document.getElementById('s-l').value = data.le || '';
            document.getElementById('is-period').checked = data.period || false;
            
            // é‹å‹•ä¸‹æ‹‰é¸å–®
            const sel = document.getElementById('sport-sel');
            sel.innerHTML = prof.sports.map(s => `<option value='${s.n}'>${s.n}</option>`).join('');
            refreshUI();
        }

        function addItem(type) {
            if(type==='food') {
                const n = document.getElementById('food-n').value || "é£Ÿç‰©";
                const k = Number(document.getElementById('food-k').value) || 0;
                tmpFood.push({n, k});
            } else {
                const n = document.getElementById('sport-sel').value;
                tmpSport.push({n, c:1});
            }
            refreshUI();
        }

        function refreshUI() {
            document.getElementById('food-list-ui').innerHTML = tmpFood.map((f,i)=>`<div class="log-item">${f.n} (${f.k}k) <b onclick="tmpFood.splice(${i},1);refreshUI()">âœ•</b></div>`).join('');
            document.getElementById('sport-list-ui').innerHTML = tmpSport.map((s,i)=>`<div class="log-item">${s.n} <b onclick="tmpSport.splice(${i},1);refreshUI()">âœ•</b></div>`).join('');
        }

        function saveAll() {
            db[selectedDate] = {
                food: tmpFood, water: Number(document.getElementById('in-water').value),
                wm: Number(document.getElementById('w-m').value), wn: Number(document.getElementById('w-n').value),
                wa: Number(document.getElementById('s-w').value), hi: Number(document.getElementById('s-h').value), le: Number(document.getElementById('s-l').value),
                sports: tmpSport, period: document.getElementById('is-period').checked
            };
            localStorage.setItem('hd_v5_db', JSON.stringify(db));
            alert("å„²å­˜æˆåŠŸ");
            updateHome();
        }

        function saveProfile() {
            prof.bday = document.getElementById('p-bday').value;
            prof.h = Number(document.getElementById('p-h').value);
            prof.w = Number(document.getElementById('p-w').value);
            localStorage.setItem('hd_v5_prof', JSON.stringify(prof));
            alert("åŸºæœ¬è³‡æ–™å·²æ›´æ–°");
        }

        function changeMonth(s) { viewDate.setMonth(viewDate.getMonth()+s); renderCalendar(); }
        
        window.onload = () => { updateHome(); };
    </script>
</body>
</html>
